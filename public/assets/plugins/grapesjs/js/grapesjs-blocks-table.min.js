function updateAttributesAndCloseModal(e){let t=document.getElementById("nRows").value,n=document.getElementById("nColumns").value;if(t||n){let o=getAllComponents(editor.getWrapper()).find(t=>t.cid==e),a=o.getAttributes();t&&(a["data-n_rows"]=t),n&&(a["data-n_columns"]=n),o.setAttributes(a)}editor.Modal.close()}function updateTableToolbarSubmenu(e,t){let n=editor.getSelected();if(n&&n.is("cell"))if(jQuery("."+t+"-operations .toolbar-submenu").length>0&&jQuery("."+t+"-operations .toolbar-submenu").slideUp("slow"),jQuery("."+e+"-operations .toolbar-submenu").length>0){if("none"!=jQuery("."+e+"-operations .toolbar-submenu").css("display"))return void jQuery("."+e+"-operations .toolbar-submenu").slideUp("slow");jQuery("."+e+"-operations .toolbar-submenu").slideDown("slow")}else{let t="";if("rows"===e)t='\n        <ul class="toolbar-submenu '+(jQuery(".gjs-toolbar").position().left>150?"toolbar-submenu-right":"")+'" style="display: none;">\n          <li class="table-toolbar-submenu-run-command" data-command="table-insert-row-above"><i class="fa fa-chevron-up" aria-hidden="true"></i> Insert row above</li>\n          <li class="table-toolbar-submenu-run-command" data-command="table-insert-row-below" ><i class="fa fa-chevron-down" aria-hidden="true"></i> Insert row below</li>\n          <li class="table-toolbar-submenu-run-command" data-command="table-delete-row" ><i class="fa fa-trash" aria-hidden="true"></i> Delete Row</li>\n          <li id="button-merge-cells-right" class="table-toolbar-submenu-run-command" data-command="table-merge-cells-right" '+(n.collection.indexOf(n)+1==n.parent().components().length?'style="display: none;"':"")+'><i class="fa fa-arrows-h" aria-hidden="true"></i> Merge cell right</li>\n        </ul>\n        ';else{let e=n.getAttributes().rowspan?n.getAttributes().rowspan:0,o=n.parent();t='\n        <ul class="toolbar-submenu '+(jQuery(".gjs-toolbar").position().left>150?"toolbar-submenu-right":"")+'" style="display: none;">\n          <li class="table-toolbar-submenu-run-command" data-command="table-insert-column-left" ><i class="fa fa-chevron-left" aria-hidden="true"></i> Insert column left</li>\n          <li class="table-toolbar-submenu-run-command" data-command="table-insert-column-right" ><i class="fa fa-chevron-right" aria-hidden="true"></i> Insert column right</li>\n          <li class="table-toolbar-submenu-run-command" data-command="table-delete-column" ><i class="fa fa-trash" aria-hidden="true"></i> Delete column</li>\n          <li id="button-merge-cells-down" class="table-toolbar-submenu-run-command" data-command="table-merge-cells-down" '+(o.collection.indexOf(o)+e==o.parent().components().length?'style="display: none;"':"")+'><i class="fa fa-arrows-v" aria-hidden="true"></i> Merge cell down</li>\n        </ul>\n        '}jQuery("."+e+"-operations").append(t),jQuery("."+e+"-operations .toolbar-submenu").slideDown("slow")}}function getAllComponents(e,t=[]){return t.push(e),e.components().each(e=>getAllComponents(e,t)),t}grapesjs.plugins.add("grapesjs-blocks-table",(e,t)=>{$(document).ready(function(){$(t.containerId?t.containerId:document).on("click","li.table-toolbar-submenu-run-command",function(){e.runCommand(this.dataset.command)}),$(t.containerId?t.containerId:document).on("click","input#table-button-create-new",function(){updateAttributesAndCloseModal(this.dataset.componentId)})}),e.DomComponents.addType("customTable",{isComponent:e=>"TABLE"===e.tagName,model:{defaults:{tagName:"table",droppable:!0,attributes:{"data-n_columns":5,"data-n_rows":3},classes:["custom-table-component"]},init(){this.listenTo(this,"change:attributes",this.updateModelComponents)},updateModelComponents(){if(this.changed.attributes&&(this.changed.attributes["data-n_columns"]||this.changed.attributes["data-n_rows"])){let e=[];for(let t=0;t<this.getAttributes()["data-n_columns"];t++)e.push({type:"cell"});for(let t=0;t<this.getAttributes()["data-n_rows"];t++)this.components().add({type:"row",components:e},{at:-1})}}}}),e.BlockManager.add("table-block",{label:"Table",category:"Basic",attributes:{class:"fa fa-table"},content:{type:"customTable"},activate:!0}),e.DomComponents.addType("cell",{isComponent:e=>"TD"===e.tagName,model:{defaults:{tagName:"td",draggable:!1,removable:!1}},view:{onRender(){let e=this;$(this.$el).dblclick(function(){0===$(this).children().length&&e.model.components().add({type:"text",content:"Text"})})}}}),e.on("component:add",t=>{"customTable"===t.attributes.type&&0==t.components().length&&e.runCommand("open-table-settings-modal",{model:t})});e.on("component:selected",t=>{"cell"==t.get("type")&&t.set("toolbar",(()=>{let t=[{attributes:{class:"fa fa-columns columns-operations",title:"Columns operations"},command:"table-show-columns-operations"},{attributes:{class:"fa fa-columns rows-operations",title:"Rows operations"},command:"table-show-rows-operations"},{attributes:{class:"fa fa-arrow-up",title:"Select parent component"},command:"table-select"}];return(e.getSelected().getAttributes().colspan>1||e.getSelected().getAttributes().rowspan>1)&&t.push({attributes:{class:"fa fa fa-th-large",title:"Unmerge cells"},command:"table-unmerge-cells"}),t})())}),e.Commands.add("table-show-columns-operations",e=>{updateTableToolbarSubmenu("columns","rows")}),e.Commands.add("table-show-rows-operations",e=>{updateTableToolbarSubmenu("rows","columns")}),e.Commands.add("table-select",e=>{e.runCommand("core:component-exit"),e.runCommand("core:component-exit")}),e.Commands.add("table-insert-row-above",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.parent();n.parent().components().add({type:"row",components:[...Array(n.components().length).keys()].map(e=>({type:"cell"}))},{at:n.collection.indexOf(n)}),e.selectRemove(t),setTimeout(function(){e.select(t)},50)}}),e.Commands.add("table-insert-row-below",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.parent();n.parent().components().add({type:"row",components:[...Array(n.components().length).keys()].map(e=>({type:"cell"}))},{at:n.collection.indexOf(n)+1}),e.selectRemove(t),setTimeout(function(){e.select(t)},50)}}),e.Commands.add("table-insert-column-left",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.collection.indexOf(t);t.parent().parent().components().forEach(e=>{e.components().add({type:"cell"},{at:n})}),e.selectRemove(t),setTimeout(function(){e.select(t)},50)}}),e.Commands.add("table-insert-column-right",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.collection.indexOf(t);t.parent().parent().components().forEach(e=>{e.components().add({type:"cell"},{at:n+1})}),e.selectRemove(t),setTimeout(function(){e.select(t)},50)}}),e.Commands.add("table-delete-row",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.parent().parent();e.selectRemove(t),t.parent().remove(),0===n.components().length&&n.parent().remove(n)}}),e.Commands.add("table-delete-column",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.parent().parent(),o=t.collection.indexOf(t);e.selectRemove(t),n.components().forEach(e=>{e.components().at(o).remove()}),n.components().every(e=>0===e.components().length)&&n.parent().remove(n)}}),e.Commands.add("table-merge-cells-right",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.getAttributes().colspan?t.getAttributes().colspan:1,o=t.collection.indexOf(t),a=t.parent().collection.indexOf(t.parent()),l=t.parent().parent(),s=t.getAttributes().rowspan>0?t.getAttributes().rowspan:1;for(let e=0;e<s;e++){let n=l.components().at(a+e).components().at(0===e?o+1:o);n.components().forEach(e=>{t.append(e.toHTML())}),n.remove()}t.addAttributes({colspan:++n}),e.selectRemove(t),setTimeout(function(){e.select(t)},50),o+1==t.parent().components().length&&jQuery("#button-merge-cells-right").hide()}}),e.Commands.add("table-merge-cells-down",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.getAttributes().colspan?t.getAttributes().colspan:1,o=t.getAttributes().rowspan?t.getAttributes().rowspan:1,a=t.collection.indexOf(t),l=t.parent().collection.indexOf(t.parent())+o-1,s=t.parent().parent();for(let e=0;e<n;e++){let e=s.components().at(l+1).components().at(a);e.components().forEach(e=>{t.append(e.toHTML())}),e.remove()}t.addAttributes({rowspan:++o}),e.selectRemove(t),setTimeout(function(){e.select(t)},50),l+2==s.components().length&&jQuery("#button-merge-cells-down").hide()}}),e.Commands.add("table-unmerge-cells",e=>{let t=e.getSelected();if(t.is("cell")){let n=t.getAttributes().colspan?t.getAttributes().colspan:1,o=t.getAttributes().rowspan?t.getAttributes().rowspan:1,a=t.collection.indexOf(t),l=t.parent().collection.indexOf(t.parent()),s=t.parent().parent();for(let e=0;e<o;e++)for(let t=0;t<n;t++)0===e&&1===n||(0===e&&0===t&&n>1&&(t=1),s.components().at(l+e).components().add({type:"cell"},{at:0===e?a+1:a}));t.setAttributes({colspan:1}),t.setAttributes({rowspan:1}),e.selectRemove(t),setTimeout(function(){e.select(t)},50),jQuery("#button-merge-cells-down").show(),jQuery("#button-merge-cells-right").show()}}),e.Commands.add("open-table-settings-modal",{run(e,t,n={}){let o=n.model.getAttributes();e.Modal.open({title:"Create new Table",content:'\n          <div class="new-table-form">\n            <label>Number of columns</label>\n            <input type="number" class="form-control" value="'+o["data-n_columns"]+'" name="nColumns" id="nColumns" min="1">\n            <br>\n            <label>Number of rows</label>\n            <input type="number" class="form-control" value="'+o["data-n_rows"]+'" name="nRows" id="nRows" min="1">\n          <div>\n          <input id="table-button-create-new" type="button" class="button nice white" value="Create Table" data-component-id="'+n.model.cid+'">\n        '}).onceClose(()=>{n.model.changed&&!n.model.changed.attributes&&n.model.remove(),this.stopCommand()})},stop(e){e.Modal.close()}})});